<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Anime - AnimMe V3</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/mobile.css">
    <style>
        .detail-container {
            max-width: 1400px;
            margin: 100px auto 0;
            padding: 0 4%;
        }
        
        .detail-header {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .detail-poster {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .detail-info h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .detail-synopsis {
            line-height: 1.8;
            margin: 20px 0;
            color: #ddd;
        }
        
        .genre-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .genre-tag {
            background-color: #e50914;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .info-section {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 25px;
            margin: 30px 0;
        }
        
        .info-section h2 {
            color: #e50914;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            padding: 12px;
            background-color: #222;
            border-radius: 6px;
        }
        
        .info-label {
            color: #999;
            min-width: 120px;
            font-weight: 600;
        }
        
        .info-value {
            color: #fff;
            flex: 1;
        }
        
        .episode-section {
            margin-top: 40px;
        }
        
        .episode-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .episode-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: block;
        }
        
        .episode-btn:hover {
            background-color: #e50914;
            border-color: #e50914;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
        }
        
        .batch-section {
            margin-top: 40px;
        }
        
        .batch-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .batch-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: block;
        }
        
        .batch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            border-color: rgba(255,255,255,0.5);
        }
        
        .recommendations-section {
            margin-top: 50px;
        }
        
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .recommendation-card {
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
        }
        
        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(229, 9, 20, 0.3);
        }
        
        .recommendation-poster {
            width: 100%;
            height: 280px;
            object-fit: cover;
        }
        
        .recommendation-info {
            padding: 15px;
        }
        
        .recommendation-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .recommendation-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #999;
            margin-top: 8px;
        }
        
        .recommendation-rating {
            color: #ffd700;
        }
        
        .recommendation-quality {
            background-color: #e50914;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #999;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: #e50914;
        }
        
        @media (max-width: 768px) {
            .detail-header {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .detail-info h1 {
                font-size: 1.8rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .episode-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .recommendations-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body class="server-v3">
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="logo" onclick="window.location.href='/v3/home'">AnimMe V3</h1>
            <div class="server-selector">
                <select id="serverSelect" class="server-select">
                    <option value="v1">V1 - Otakudesu</option>
                    <option value="v2">V2 - Samehadaku</option>
                    <option value="v3" selected>V3 - Kuramanime</option>
                </select>
            </div>
            <div class="nav-menu">
                <a href="/v3/home" class="nav-link">Beranda</a>
                <a href="/v3/search" class="nav-link">Cari Anime</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="detail-container" id="detailContent">
            <div class="loading">Memuat detail anime...</div>
        </div>
    </main>

    <!-- Batch Download Modal -->
    <div id="batchModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; overflow-y:auto;">
        <div style="max-width:800px; margin:50px auto; background:#1a1a1a; border-radius:12px; padding:30px; position:relative;">
            <button onclick="closeBatchModal()" style="position:absolute; top:15px; right:15px; background:#e50914; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">✕ Tutup</button>
            <div id="batchModalContent"></div>
        </div>
    </div>

    <script>
        // Extract animeId and slug from URL (support both path and query params)
        const urlParams = new URLSearchParams(window.location.search);
        let animeId = urlParams.get('animeId');
        let slug = urlParams.get('slug');
        
        // Fallback to path-based params if query params not found
        if (!animeId || !slug) {
            const segments = window.location.pathname.split('/').filter(Boolean);
            const detailIndex = segments.indexOf('detail');
            if (detailIndex !== -1 && segments.length > detailIndex + 2) {
                animeId = segments[detailIndex + 1];
                slug = segments.slice(detailIndex + 2).join('/');
            }
        }

        // Load anime detail
        async function loadAnimeDetail() {
            if (!animeId || !slug) {
                showError('Parameter detail tidak valid');
                return;
            }
            try {
                const response = await fetch(`/api/v3/kuramanime/anime/${animeId}/${slug}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayAnimeDetail(result.data);
                } else {
                    showError('Gagal memuat detail anime');
                }
            } catch (error) {
                console.error('Error loading anime detail:', error);
                showError('Terjadi kesalahan saat memuat data');
            }
        }

        function displayAnimeDetail(anime) {
            const container = document.getElementById('detailContent');
            
            // Filter real genres (exclude non-genre items)
            const realGenres = anime.genres.filter(g => {
                const lower = g.toLowerCase();
                return !lower.includes('sunrise') && 
                       !lower.includes('/') && 
                       !lower.includes('orang') &&
                       !lower.includes('pg-') &&
                       !lower.includes('bglobal');
            });
            
            container.innerHTML = `
                <div class="detail-header">
                    <div>
                        <img src="${anime.poster}" alt="${anime.title}" class="detail-poster">
                    </div>
                    <div class="detail-info">
                        <h1>${anime.title}</h1>
                        
                        ${realGenres.length > 0 ? `
                        <div class="genre-list">
                            ${realGenres.map(genre => `
                                <span class="genre-tag">${genre.replace(',', '')}</span>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div class="detail-synopsis">
                            <strong>Sinopsis:</strong><br>
                            ${anime.synopsis || 'Tidak ada sinopsis tersedia.'}
                        </div>
                    </div>
                </div>
                
                <!-- Info Section -->
                <div class="info-section">
                    <h2>📋 Informasi Anime</h2>
                    <div class="info-grid">
                        ${Object.entries(anime.info).map(([key, value]) => {
                            if (!value || value.trim() === '' || value === '?') return '';
                            
                            // Format label
                            const label = key.split('_').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1)
                            ).join(' ');
                            
                            // Clean value (remove extra whitespace)
                            const cleanValue = value.replace(/\s+/g, ' ').trim();
                            
                            return `
                                <div class="info-item">
                                    <span class="info-label">${label}:</span>
                                    <span class="info-value">${cleanValue}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Episodes Section -->
                ${anime.episodes && anime.episodes.length > 0 ? `
                <div class="episode-section">
                    <h2>📺 Daftar Episode (${anime.episodes.length})</h2>
                    <div class="episode-list">
                        ${anime.episodes.map(episode => {
                            // Extract episode number from title or URL
                            const episodeMatch = episode.title.match(/Episode\s+(\d+)/i) || episode.url.match(/episode\/(\d+)/);
                            const episodeNum = episodeMatch ? episodeMatch[1] : '1';
                            
                            return `
                                <a href="/v3/episode?animeId=${animeId}&slug=${slug}&episode=${episodeNum}" 
                                   class="episode-btn" 
                                   title="${episode.title}">
                                    ${episode.title}
                                </a>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Batch Download Section -->
                ${anime.batch_list && anime.batch_list.length > 0 ? `
                <div class="batch-section">
                    <h2>📦 Batch Download (${anime.batch_list.length})</h2>
                    <div class="batch-list">
                        ${anime.batch_list.map(batch => `
                            <a href="#" 
                               class="batch-btn" 
                               onclick="openBatchModal('${animeId}', '${slug}', '${batch.range}', '${batch.title}'); return false;"
                               title="Download ${batch.title}">
                                ${batch.title}
                            </a>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Anime Lainnya Section -->
                ${anime.anime_lainnya && anime.anime_lainnya.length > 0 ? `
                <div class="recommendations-section">
                    <h2>🎬 Anime Lainnya / Rekomendasi</h2>
                    <div class="recommendations-grid">
                        ${anime.anime_lainnya.map(rec => `
                            <a href="/v3/detail?animeId=${rec.anime_id}&slug=${rec.slug}" class="recommendation-card">
                                <img src="${rec.poster}" alt="${rec.title}" class="recommendation-poster">
                                <div class="recommendation-info">
                                    <div class="recommendation-title">${rec.title}</div>
                                    <div class="recommendation-meta">
                                        <span class="recommendation-rating">⭐ ${rec.rating}</span>
                                        ${rec.quality ? `<span class="recommendation-quality">${rec.quality}</span>` : ''}
                                    </div>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function showError(message) {
            const container = document.getElementById('detailContent');
            container.innerHTML = `
                <div class="error">
                    <h2>❌ ${message}</h2>
                    <p>Silakan coba lagi nanti atau kembali ke <a href="/v3/home">beranda</a>.</p>
                </div>
            `;
        }

        // Batch download modal functions
        async function openBatchModal(animeId, slug, range, title) {
            const modal = document.getElementById('batchModal');
            const content = document.getElementById('batchModalContent');
            
            modal.style.display = 'block';
            content.innerHTML = '<div style="text-align:center; padding:30px; color:#fff;"><h3>Memuat download links...</h3></div>';
            
            try {
                const response = await fetch(`/api/v3/kuramanime/batch/${animeId}/${slug}/${range}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayBatchDownloads(result.data);
                } else {
                    content.innerHTML = '<div style="color:#e50914; text-align:center; padding:30px;"><h3>Gagal memuat download links</h3></div>';
                }
            } catch (error) {
                console.error('Error loading batch:', error);
                content.innerHTML = '<div style="color:#e50914; text-align:center; padding:30px;"><h3>Terjadi kesalahan saat memuat data</h3></div>';
            }
        }
        
        function displayBatchDownloads(batch) {
            const content = document.getElementById('batchModalContent');
            
            // Group download links by quality (quality now includes size)
            const groupedLinks = {};
            if (batch.download_links) {
                batch.download_links.forEach(link => {
                    const quality = link.quality || 'Unknown Quality';
                    if (!groupedLinks[quality]) {
                        groupedLinks[quality] = [];
                    }
                    groupedLinks[quality].push(link);
                });
            }
            
            content.innerHTML = `
                <h2 style="color:#fff; margin-bottom:20px;">${batch.title}</h2>
                
                ${batch.synopsis ? `
                <div style="color:#ddd; margin-bottom:20px; line-height:1.6;">
                    <strong>Sinopsis:</strong> ${batch.synopsis}
                </div>
                ` : ''}
                
                ${Object.keys(groupedLinks).length > 0 ? `
                <div style="margin-top:30px;">
                    <h3 style="color:#fff; margin-bottom:15px;">📥 Download Links:</h3>
                    ${Object.entries(groupedLinks).map(([quality, links]) => `
                        <div style="background:#222; padding:20px; border-radius:8px; margin-bottom:20px;">
                            <h4 style="color:#e50914; margin-bottom:15px;">${quality}</h4>
                            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                ${links.map(link => `
                                    <a href="${link.url}" 
                                       target="_blank"
                                       style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                              color:#fff; 
                                              padding:10px 20px; 
                                              border-radius:6px; 
                                              text-decoration:none; 
                                              font-weight:bold;
                                              transition:all 0.3s;"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.5)';"
                                       onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                        ${link.provider}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : '<p style="color:#999; text-align:center; padding:20px;">Download links tidak tersedia</p>'}
            `;
        }
        
        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        document.getElementById('batchModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'batchModal') {
                closeBatchModal();
            }
        });

        // Server selector
        document.getElementById('serverSelect').addEventListener('change', (e) => {
            const server = e.target.value;
            localStorage.setItem('selectedServer', server);
            if (server === 'v3') {
                window.location.href = '/v3/home';
            } else if (server === 'v2') {
                window.location.href = '/v2/home';
            } else {
                window.location.href = '/v1/home';
            }
        });

        // Load anime detail when page loads
        loadAnimeDetail();
    </script>
</body>
</html>
